<!DOCTYPE html>
<!--
  Original Design: Spectral by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
  Jekyll build mod
-->
<html>

  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Exploring NYC&#39;s CitiBike</title>
  <meta name="description" content=" Full code on">
  <!--[if lte IE 8]><script src="/js/ie/html5shiv.js"></script><![endif]-->
  <link rel="canonical" href="http://luisvalesilva.github.io/datasimple/posts/citibike">
  <link rel="stylesheet" href="/css/main.css" />
  <!--[if lte IE 8]><link rel="stylesheet" href="/css/ie8.css" /><![endif]-->
  <!--[if lte IE 9]><link rel="stylesheet" href="/css/ie9.css" /><![endif]-->
  <link rel="alternate" type="application/rss+xml" title="Data Simple" href="http://luisvalesilva.github.io/datasimple/feed.xml">
  <!-- FavIcon -->
  <link rel="icon" href="//images/datasimple_favicon.ico" type="image/x-icon">

  <!-- Google Analytics -->
		<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-71624249-1', 'auto');
  ga('send', 'pageview');
  </script>
</head>


  <body>

    <!-- Page Wrapper -->
    <div id="page-wrapper">

      <!-- Header -->
<header id="header">
  <h1><a href="/index.html">Data Simple</a></h1>
  <nav id="nav">
    <ul>
      <li class="special">
        <a href="#menu" class="menuToggle"><span>Menu</span></a>
        <div id="menu">
          <ul>
            <li><a href="/index.html">Home</a></li>
            <!--
            
            
            
            
            
            
            
            
            
            
            
            <li><a href="/feed.xml"
                   class="icon fa-feed"> RSS Feed</a></li>
            -->
            <li><a href="/index.html/#cta">All posts</a></li>
            <li><a href="/about.html">About</a></li>
          </ul>
        </div>
      </li>
    </ul>
  </nav>
</header>


      <article id="main">
<link href="/css/syntax.css" rel="stylesheet">

  <header>
    <p>November 2015</p>
    <h2>Exploring NYC's CitiBike</h2>
    <p>Or how to make interactive maps with Python and Folium</p>
  </header>

  <section class="wrapper style5">
    <div class="inner">
      <center>
<h5> Full code on
<a target="_blank" href="https://github.com/luisvalesilva/exploring_citibike" class="icon fa-github" style="font-size:2.5em;"></a>
</h5>
</center>
<p><br /><br /></p>

<p>CitiBike is the public bicycle sharing system serving New York City. The service
opened in May 2013 and is currently the largest bike sharing program in the United
States. A nice thing about it is that CitiBike share their data for anyone to play
with. Here I will do just that, using Python. The final goal is to build interactive
visualizations of total trip counts and trip durations on maps of the CitiBike station
network. The following is a summarized description of the analysis, including data
manipulation (with <a href="http://pandas.pydata.org/">Pandas</a>) and map visualizations (with
<a href="http://folium.readthedocs.org/en/latest/">Folium</a>).</p>

<h3 id="preparing-the-data">Preparing the data</h3>

<p>CitiBike’s data can be found on their <a href="https://www.citibikenyc.com/system-data">System Data website</a>.
The data are organized in monthly subsets (each in its own <em>.csv</em> file) and are available
since July 2013, soon after the CitiBike service opened. The last available month,
as of this writing, is October 2015 (last month). Using data from one whole year
seems most appropriate. It will provide a manageable amount of data and also capture
yearly patterns. For this exercise I will thus use all 2014 data, the only full year
available so far. The data have been pre-cleaned before uploading, for example by
removing trips taken by staff and any trips below 60 seconds in length. This means
they are ready to use, likely with little need for additional cleaning.</p>

<p>The first step is to download the 12 <em>.csv</em> files for all months in 2014. We can
read in the file names and then use a <code class="highlighter-rouge">for loop</code> to load the data as 12 Pandas
data frames appended to a list.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">glob</span>
<span class="c"># Get file names</span>
<span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">'*.csv'</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="c"># Loop through file names and read the data</span>
<span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Reading '</span> <span class="o">+</span> <span class="nb">file</span><span class="p">)</span>
    <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="nb">file</span><span class="p">))</span></code></pre></figure>

<p>Here’s a screenshot showing an example of what the data look like after loading in Pandas. You can see the included variables and two observations each for the August and the September data frames.</p>

<center>
<img src="../images/citibike/df_august.png" alt="Screenshot" />
<img src="../images/citibike/df_september.png" alt="Screenshot" />
</center>

<p>Turns out the data are not as clean as I originally thought. The time stamps (variables
<code class="highlighter-rouge">starttime</code>	and <code class="highlighter-rouge">stoptime</code>) are formatted in one way in months up to August and in
a different way in the remaining months.	You can see examples in the screenshots above.
One way to consolidate the format is to use Pandas’ <code class="highlighter-rouge">to_datetime</code> function to convert
the variables to the appropriate data type (Pandas uses NumPy’s <code class="highlighter-rouge">datetime64</code>). A
little <code class="highlighter-rouge">for loop</code> helps save some typing. For the months from September on I need
to include information about the format, as it changes.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="s">'Converting month:'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">month</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'... '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">dfs</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="s">'starttime'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfs</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="s">'starttime'</span><span class="p">])</span>
        <span class="n">dfs</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="s">'stoptime'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfs</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="s">'stoptime'</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'... '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">dfs</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="s">'starttime'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfs</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="s">'starttime'</span><span class="p">],</span> <span class="n">format</span> <span class="o">=</span> <span class="s">'</span><span class="si">%</span><span class="s">m/</span><span class="si">%</span><span class="s">d/</span><span class="si">%</span><span class="s">Y </span><span class="si">%</span><span class="s">H:</span><span class="si">%</span><span class="s">M:</span><span class="si">%</span><span class="s">S'</span><span class="p">)</span>
        <span class="n">dfs</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="s">'stoptime'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfs</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="s">'stoptime'</span><span class="p">],</span> <span class="n">format</span> <span class="o">=</span> <span class="s">'</span><span class="si">%</span><span class="s">m/</span><span class="si">%</span><span class="s">d/</span><span class="si">%</span><span class="s">Y </span><span class="si">%</span><span class="s">H:</span><span class="si">%</span><span class="s">M:</span><span class="si">%</span><span class="s">S'</span><span class="p">)</span></code></pre></figure>

<p>Now that the timestamps are consistent, I can concatenate the datasets into one single
data frame containing all data. Finally, I can use the pickle module (part of the
Python standard library)	to save the clean Pandas data frame for future use (a
concept known as serialization). This will write a <em>.pkl</em> file to disk that I can
save and easily read back into memory at any point in the future.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Concatenate DataFrames</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
<span class="c"># Pickle data</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s">'citibike_2014.pkl'</span><span class="p">)</span></code></pre></figure>

<p>Let’s move on and get more familiar with the data. There are several rather high level
questions we can quickly address to get an overview of the data. The code below shows
how to compute a few of them. The results show that our 2014 dataset includes <strong>8,081,216</strong>
observations of <strong>15</strong> variables. There were <strong>332</strong> CitiBike stations and <strong>6,811</strong>
different bikes in use.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s">'citibike_2014.pkl'</span><span class="p">)</span> <span class="c"># Read data</span>
<span class="n">df</span><span class="o">.</span><span class="n">shape</span> <span class="c"># How many observations and variables are there</span>
<span class="n">df</span><span class="p">[</span><span class="s">'bikeid'</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span> <span class="c"># Number of individual bikes</span>
<span class="n">df</span><span class="p">[</span><span class="s">'start station id'</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span> <span class="c"># Number of citibike stations</span></code></pre></figure>

<p>There are many ways we could go about exploring the data now. In this analysis I will
be focusing on comparing the use of the different CitiBike stations in the network,
particularly according to number of trips and trip duration. The <strong>final goal</strong> is
to build <strong>visualizations of total trip counts and trip durations on maps of the
CitiBike station network</strong>.</p>

<h3 id="interactive-map-of-citibike-station-use">Interactive map of CitiBike station use</h3>

<p>I will start by looking at trip counts and trip durations, to get a better view of
the data. One way to look at trip counts is to plot number of trips per day over the
entire year of 2014.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">'ggplot'</span><span class="p">)</span>

<span class="c"># Compute trip counts / day</span>
<span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'starttime'</span><span class="p">]</span> <span class="c"># Set 'starttime' variable as the index</span>
<span class="n">countsPerDay</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s">'D'</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="p">[</span><span class="s">'count'</span><span class="p">])</span>

<span class="c"># Plot trip counts</span>
<span class="n">countsPerDay</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span> <span class="o">=</span> <span class="s">'area'</span><span class="p">,</span> <span class="n">stacked</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                  <span class="n">color</span> <span class="o">=</span> <span class="s">'darkorange'</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="s">'both'</span><span class="p">,</span> <span class="n">which</span> <span class="o">=</span> <span class="s">'major'</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Number of trips / day</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">''</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Number of trips'</span><span class="p">)</span></code></pre></figure>

<center>
<img src="../images/citibike/daily_trip_counts.png" alt="Daily trip counts" style="width: 800px;" />
</center>

<p>The plot shows a general trend of increasing number of trips from the Winter months
towards the Summer and a decrease thereafter, going back to harsher weather. Regular
sharp decreases in daily trip counts are also clearly seen, corresponding to weekends
and holidays.</p>

<p>In order to visualize trip durations I can plot an histogram of the <code class="highlighter-rouge">tripduration</code>
variable. The histogram reveals that most trips are rather short,	with most frequent
durations not longer than 10 minutes. Durations longer than 30 minutes are quite rare.
Here I am excluding all trips with durations longer than 1 hour, representing rare outliers.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Collect all trips shorter than 1 hour</span>
<span class="n">duration_mins</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">tripduration</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">)][[</span><span class="s">'tripduration'</span><span class="p">]]</span>
<span class="n">duration_mins</span> <span class="o">=</span> <span class="n">duration_mins</span> <span class="o">/</span> <span class="mi">60</span> <span class="c"># In minutes</span>

<span class="c"># Plot the distribution of trip durations</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">'font.size'</span><span class="p">:</span> <span class="mi">16</span><span class="p">})</span>
<span class="n">duration_mins</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">'orange'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="s">'both'</span><span class="p">,</span> <span class="n">which</span> <span class="o">=</span> <span class="s">'major'</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Distribution of trip durations</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Duration (min.)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Trip counts'</span><span class="p">)</span></code></pre></figure>

<center>
<img src="../images/citibike/hist_trip_duration.png" alt="Histogram trip duration" style="width: 550px;" />
</center>

<p>We can now work on mapping station use. I will build the map using trip start stations,
so I first need to prepare the data. The idea is to make a new data frame containing
the data need to build the interactive map. The first step is to collect the subset
of variables with information on trip start stations. I then drop duplicate station
observations, to keep only one row for each individual CitiBike station. Finally,
I can compute total trip counts out of each station, as well as mean trip duration
(using the original complete data frame). These values are stored in two new variables,
<code class="highlighter-rouge">trip count</code> and <code class="highlighter-rouge">mean duration</code>, and added to the new data frame.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Build a table containing the stations - one observation per station</span>
<span class="n">start_station</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]]</span> <span class="c"># Keep only required variables</span>
<span class="n">start_station</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">start_station</span><span class="p">[</span><span class="s">'start station id'</span><span class="p">]</span> <span class="c"># Index by start station id</span>
<span class="n">start_station</span> <span class="o">=</span> <span class="n">start_station</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span> <span class="c"># Keep only one row per station</span>

<span class="c"># Compute trip counts and mean trip duration for each start station and add to table</span>
<span class="n">count_start_station</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'start station id'</span><span class="p">)[</span><span class="s">'start station id'</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">mean_start_station</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'start station id'</span><span class="p">)[</span><span class="s">'tripduration'</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">start_station</span><span class="p">[</span><span class="s">'trip count'</span><span class="p">]</span> <span class="o">=</span> <span class="n">count_start_station</span>
<span class="n">start_station</span><span class="p">[</span><span class="s">'mean duration'</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_start_station</span></code></pre></figure>

<p>I can now use Folium to make the interactive map of the station network. The map will
include one marker for each station, with a color scale proportional to trip counts
out of that station and marker size proportional to mean trip duration. Folium comes
with a few <em>tilesets</em> you can use directly. I prefer the dark <em>tileset</em> from CartoBD,
so I will be using that instead.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">folium</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">Normalize</span><span class="p">,</span> <span class="n">rgb2hex</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="kn">as</span> <span class="nn">cm</span>

<span class="c"># Normalize trip counts</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">start_station</span><span class="p">[</span><span class="s">'trip count'</span><span class="p">]</span><span class="o">.</span><span class="nb">min</span><span class="p">(),</span> <span class="n">start_station</span><span class="p">[</span><span class="s">'trip count'</span><span class="p">]</span><span class="o">.</span><span class="nb">max</span><span class="p">())</span>
<span class="c"># Get dark tileset from CartoBD (https://cartodb.com/basemaps)</span>
<span class="n">tileset</span> <span class="o">=</span> <span class="s">r'http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png'</span>
<span class="c"># Build Folium map</span>
<span class="n">start_station_map</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="p">[</span><span class="mf">40.74</span><span class="p">,</span> <span class="o">-</span><span class="mf">73.99</span><span class="p">],</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span>
                               <span class="n">tiles</span> <span class="o">=</span> <span class="n">tileset</span><span class="p">,</span>
                               <span class="n">attr</span> <span class="o">=</span> <span class="s">'© OpenStreetMap contributors, © CartoDB'</span><span class="p">,</span>
                               <span class="n">zoom_start</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
<span class="c"># Loop through rows (one per station) and compute marker color (trip counts) and size (trip duration)</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">start_station</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">rgb2hex</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">YlOrRd</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">'trip count'</span><span class="p">])))</span>
    <span class="n">start_station_map</span><span class="o">.</span><span class="n">circle_marker</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s">'start station latitude'</span><span class="p">],</span>
                                                <span class="n">row</span><span class="p">[</span><span class="s">'start station longitude'</span><span class="p">]],</span>
                                    <span class="n">popup</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">'start station name'</span><span class="p">],</span> <span class="c"># Add labels with station name</span>
                                    <span class="n">radius</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">'mean duration'</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span>
                                    <span class="n">fill_color</span> <span class="o">=</span> <span class="n">color</span><span class="p">,</span> <span class="n">line_color</span> <span class="o">=</span> <span class="n">color</span><span class="p">)</span>
<span class="c"># Create the final html document</span>
<span class="n">start_station_map</span><span class="o">.</span><span class="n">create_map</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">'start_station_map.html'</span><span class="p">)</span></code></pre></figure>

<p>And here is the final result. The map shows markers for all stations, each clickable
to show the station name. Marker color is proportional to total trip counts (color
scale shown next to the maps) starting at the station. Marker size is proportional
to mean trip duration, from a minimum of 9.5 minutes up to a maximum of about 1 hour.</p>

<center>
			<h4>CitiBike station use for trip start</h4>
			<h6>Color scale of trip counts<br />Size scale of mean trip duration (9.5 min. up to 1 hour)</h6>
			<iframe style="border: 1px solid #ccc" width="402" height="602" src="../images/citibike/start_station_map.html"></iframe>
			<img src="../images/citibike/color_scale_start_station.png" alt="Color scale" />
</center>
<p><br /></p>

<h3 id="dynamic-map-of-daily-use-of-citibike-stations">Dynamic map of daily use of CitiBike stations</h3>

<p>This map lumps together all trips taken in 2014 for each station. Another interesting
way to look at the data is to compute trip counts per hour and see how they change
during the average day. The following code prepares the data for that, additionally
separating weekdays and weekends, as different use of CitiBike can be expected.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Calculate trip counts per hour on weekdays and weekends</span>
<span class="n">df_sub</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s">'tripduration'</span><span class="p">,</span> <span class="s">'starttime'</span><span class="p">]]</span> <span class="c"># Keep only 'starttime' and 'tripduration' variables</span>
<span class="c"># Index dataframe by 'datetime64' data in 'starttime' variable</span>
<span class="n">df_sub</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_sub</span><span class="p">[</span><span class="s">'starttime'</span><span class="p">]</span>
<span class="n">weekdays</span> <span class="o">=</span> <span class="n">df_sub</span><span class="p">[</span><span class="n">df_sub</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">weekday</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">weekends</span> <span class="o">=</span> <span class="n">df_sub</span><span class="p">[</span><span class="n">df_sub</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">weekday</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">]</span>
<span class="n">weekdays_countsPerHr</span> <span class="o">=</span> <span class="n">weekdays</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">weekdays</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
<span class="n">weekends_countsPerHr</span> <span class="o">=</span> <span class="n">weekends</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">weekends</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
<span class="c"># Plot counts / hour on weekdays and weekends</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">'font.size'</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="s">'legend.fontsize'</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
<span class="n">weekdays_countsPerHr</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span> <span class="o">=</span> <span class="s">'area'</span><span class="p">,</span> <span class="n">stacked</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s">'darkorange'</span><span class="p">,</span>
                          <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Weekdays'</span><span class="p">)</span>

<span class="n">weekends_countsPerHr</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span> <span class="o">=</span> <span class="s">'area'</span><span class="p">,</span> <span class="n">stacked</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">'darkred'</span><span class="p">,</span>
                          <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Weekends'</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="s">'both'</span><span class="p">,</span> <span class="n">which</span> <span class="o">=</span> <span class="s">'major'</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Number of trips / hour</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Time of day (hr)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Number of trips'</span><span class="p">)</span>
<span class="n">legend</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">'upper left'</span><span class="p">,</span> <span class="n">frameon</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span></code></pre></figure>

<center>
<img src="../images/citibike/hourly_trip_counts.png" alt="Hourly trip counts" style="width: 550px;" />
</center>

<p>The plot shows that there are two clear commuting peaks on weekdays. On weekends
the use pattern is different, as expected, and there are overall less trips per hour.
It would be interesting to visualize the dynamics of station use during the average
weekday. In order to do that, I can build hourly maps of station use for every hour
using weekday data and then use them to make a video illustrating the changes.
The final result, shown here below, is a dynamic visualization of how trip count
(marker color) and trip duration (marker size) change over the 24 hours on the average
weekday.</p>

<center>
     <h4>CitiBike station use for trip start <br />
     on the average weekday</h4>
      <h6>Color scale of trip counts<br />
      Size scale of mean trip duration (2 min. up to 1 hour 45 min.)</h6>
       <iframe src="https://player.vimeo.com/video/149019949" width="250" height="400" frameborder="0" align="middle"></iframe>
       <img src="../images/citibike/color_scale_start_station_hourly.png" alt="Color scale" />
     </center>
<p><br /></p>

<p>This is it. I hope this gave you a little taste of how powerful Pandas is to manipulate
data and how easy Folium makes it to build interactive maps. Again, you can see the
full code, including the analyses shown here and more, in a Jupyter Notebook file in
this GitHub <a href="https://github.com/luisvalesilva/exploring_citibike">repo</a>.</p>

    </div>
  </section>

</article>


      <!-- Footer -->
<footer id="footer">
  <!--
  <ul class="icons">
    
    
    
    <li><a target="_blank" href="https://twitter.com/luisvalesilva" class="icon fa-twitter"
           ><span class="label">twitter</span></a></li>
    
    
    
    
    
    <li><a target="_blank" href="https://github.com/luisvalesilva" class="icon fa-github"
           ><span class="label">github</span></a></li>
    
    
    
    
    
    <li><a target="_blank" href="https://linkedin.com/in/luís-a-vale-silva-81950b4a" class="icon fa-linkedin-square"
           ><span class="label">linkedin-square</span></a></li>
    
    
    
    
    
    <li><a target="_blank" href="http://www.google.com/recaptcha/mailhide/d?k=01h1j_xgyB90IVGIZ9dA1Jfw==&c=Xhj_bgIAV8FLfilx0RETrFW9ECDjyd_22S11MmM8YEI=" class="icon fa-envelope-o"
           ><span class="label">E-mail</span></a></li>
    
    
    
  </ul>
  -->
  <ul class="copyright">
    <li>&copy; 
    
      
      
    
    2016
    Luis Vale Silva</li>
    <li>Design based on Spectral (by <a href="http://html5up.net" target="_blank">HTML5 UP</a>)</li>
    <li>Built with <a href="http://jekyllrb.com" target="_blank">Jekyll</a></li>
    <li>Hosted on <a href="https://pages.github.com/" target="_blank">GitHub Pages</a></li>
  </ul>
</footer>


      <!-- Scripts -->
<script src="/js/jquery.min.js"></script>
<script src="/js/jquery.scrollex.min.js"></script>
<script src="/js/jquery.scrolly.min.js"></script>
<script src="/js/skel.min.js"></script>
<script src="/js/util.js"></script>
<!--[if lte IE 8]><script src="js/ie/respond.min.js"></script><![endif]-->
<script src="/js/main.js"></script>


    </div>

  </body>

</html>
